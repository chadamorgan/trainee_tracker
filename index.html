<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drill Sergeant Trainee Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Using Inter font from Google Fonts for a modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light gray background */
            color: #1f2937;
            transition: overflow 0.3s ease;
        }
        /* Lock body scroll when a modal is open */
        body.modal-open {
            overflow: hidden;
        }
        .notification-banner {
            top: 0;
            left: 0;
            right: 0;
            z-index: 40;
            transition: all 0.5s ease-in-out;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        /* Custom scrollbar for better aesthetics in modals */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Simple spinner for loading states on buttons */
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Notification Banner -->
    <div id="notificationBanner" class="notification-banner fixed hidden p-4 bg-yellow-400 text-yellow-900 rounded-lg shadow-xl m-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                <span id="notificationMessage" class="font-semibold"></span>
            </div>
            <button onclick="document.getElementById('notificationBanner').classList.add('hidden')" class="text-yellow-900 hover:text-yellow-700 font-bold ml-4">&times;</button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">Platoon Tracker</h1>
            <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4 mt-4 md:mt-0">
                <div class="p-3 bg-indigo-100 rounded-lg shadow-inner text-center flex items-center space-x-2">
                    <p class="text-lg font-bold text-indigo-800" id="availableCount">0 / 0 Trainees Available</p>
                    <select id="dashboardPlatoonFilter" class="rounded-md border-gray-300 shadow-sm text-sm text-gray-700">
                        <option value="All">All Platoons</option>
                    </select>
                </div>
                <button id="addTraineeBtn" class="w-full md:w-auto px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full shadow-md hover:bg-indigo-700 transition-all">
                    Add Trainee
                </button>
                <button id="bulkAddBtn" class="w-full md:w-auto px-6 py-2 bg-gray-600 text-white font-semibold rounded-full shadow-md hover:bg-gray-700 transition-all">
                    Bulk Add
                </button>
                <button id="resetAppBtn" class="w-full md:w-auto px-6 py-2 bg-red-600 text-white font-semibold rounded-full shadow-md hover:bg-red-700 transition-all">
                    Reset App
                </button>
            </div>
        </div>

        <!-- Authentication and User Info -->
        <div class="bg-gray-100 p-4 rounded-lg mb-6 shadow-inner">
            <h3 class="text-lg font-semibold text-gray-800">User Information</h3>
            <p id="authStatus" class="mt-1 text-sm text-gray-600">Loading...</p>
            <p id="userIdDisplay" class="mt-1 text-sm text-gray-600 break-all"></p>
        </div>

        <!-- Platoon Dashboard -->
        <div class="bg-gray-100 p-4 rounded-xl shadow-inner mb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Platoon Dashboard</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Status counts -->
                <div class="p-3 bg-white rounded-lg shadow-md text-center cursor-pointer hover:bg-gray-100 transition-colors" data-filter="All">
                    <p class="text-sm font-medium text-gray-600">Complete Roster</p>
                    <p id="rosterCount" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                </div>
                <div class="p-3 bg-white rounded-lg shadow-md text-center cursor-pointer hover:bg-gray-100 transition-colors" data-filter="Present">
                    <p class="text-sm font-medium text-gray-600">Present</p>
                    <p id="presentCount" class="text-2xl font-bold text-green-600 mt-1">0</p>
                </div>
                <div class="p-3 bg-white rounded-lg shadow-md text-center cursor-pointer hover:bg-gray-100 transition-colors" data-filter="Sick Call">
                    <p class="text-sm font-medium text-gray-600">Sick Call</p>
                    <p id="sickCallCount" class="text-2xl font-bold text-yellow-600 mt-1">0</p>
                </div>
                <div class="p-3 bg-white rounded-lg shadow-md text-center cursor-pointer hover:bg-gray-100 transition-colors" data-filter="Profile">
                    <p class="text-sm font-medium text-gray-600">Profiles</p>
                    <p id="profileCount" class="text-2xl font-bold text-red-600 mt-1">0</p>
                </div>
                <div class="p-3 bg-white rounded-lg shadow-md text-center cursor-pointer hover:bg-gray-100 transition-colors" data-filter="Unqualified">
                    <p class="text-sm font-medium text-gray-600">Unqualified</p>
                    <p id="unqualifiedCount" class="text-2xl font-bold text-purple-600 mt-1">0</p>
                </div>
                <div class="p-3 bg-white rounded-lg shadow-md text-center cursor-pointer hover:bg-gray-100 transition-colors" data-filter="ACFT Fail">
                    <p class="text-sm font-medium text-gray-600">ACFT Fail</p>
                    <p id="acftFailCount" class="text-2xl font-bold text-red-600 mt-1">0</p>
                </div>
                <!-- New Dashboard Cards for Training Events and Tasks -->
                <div class="p-3 bg-white rounded-lg shadow-md text-center cursor-pointer hover:bg-gray-100 transition-colors" id="openEventsModal">
                    <p class="text-sm font-medium text-gray-600">Training Events</p>
                    <p id="totalEventsCount" class="text-2xl font-bold text-blue-600 mt-1">0</p>
                </div>
                <div class="p-3 bg-white rounded-lg shadow-md text-center cursor-pointer hover:bg-gray-100 transition-colors" id="openTasksModal">
                    <p class="text-sm font-medium text-gray-600">Platoon Tasks</p>
                    <p id="outstandingTasksCount" class="text-2xl font-bold text-purple-600 mt-1">0</p>
                </div>
                <!-- Gender Breakdown Cards -->
                <div class="p-3 bg-white rounded-lg shadow-md text-center cursor-pointer hover:bg-gray-100 transition-colors" data-filter="Male">
                    <p class="text-sm font-medium text-gray-600">Males</p>
                    <p id="maleCount" class="text-2xl font-bold text-indigo-600 mt-1">0</p>
                </div>
                <div class="p-3 bg-white rounded-lg shadow-md text-center cursor-pointer hover:bg-gray-100 transition-colors" data-filter="Female">
                    <p class="text-sm font-medium text-gray-600">Females</p>
                    <p id="femaleCount" class="text-2xl font-bold text-pink-600 mt-1">0</p>
                </div>
            </div>
            <div class="mt-4">
                <h4 class="text-md font-semibold text-gray-800">Upcoming Appointments:</h4>
                <ul id="upcomingAppointmentsList" class="mt-2 space-y-1 text-sm text-gray-600">
                    <!-- Appointments will be populated here -->
                </ul>
            </div>
            <div class="mt-4">
                <h4 class="text-md font-semibold text-gray-800">Priority List:</h4>
                <ul id="priorityList" class="mt-2 space-y-1 text-sm text-gray-600">
                    <!-- High priority notes will be populated here -->
                </ul>
            </div>
        </div>

        <!-- Add Trainee Form (Initially Hidden) -->
        <div id="addTraineeFormContainer" class="bg-blue-50 p-6 rounded-lg mb-6 shadow-md transition-all duration-300 hidden">
            <h2 class="text-2xl font-bold text-blue-800 mb-4">New Trainee</h2>
            <form id="traineeForm" class="space-y-4">
                <div>
                    <label for="traineeName" class="block text-sm font-medium text-gray-700">Trainee Name</label>
                    <input type="text" id="traineeName" name="name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="platoonName" class="block text-sm font-medium text-gray-700">Platoon/Company</label>
                        <input type="text" id="platoonName" name="platoon" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="traineeRank" class="block text-sm font-medium text-gray-700">Rank</label>
                        <input type="text" id="traineeRank" name="rank" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label for="traineeGender" class="block text-sm font-medium text-gray-700">Gender</label>
                    <select id="traineeGender" name="gender" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancelAddBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-blue-600 hover:bg-blue-700">Save Trainee</button>
                </div>
            </form>
        </div>

        <!-- Trainee List and Filter -->
        <div class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-4 sm:space-y-0">
                <h2 class="text-2xl font-bold text-gray-900" id="rosterHeader">Trainee Roster</h2>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                    <input type="text" id="traineeSearch" placeholder="Search by name..." class="w-full sm:w-auto px-4 py-2 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    <select id="platoonFilter" class="w-full sm:w-auto px-4 py-2 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="All">All Platoons</option>
                    </select>
                </div>
            </div>
            <div id="traineeListContainer" class="space-y-4">
                <p id="loadingStatus" class="text-center text-gray-500">Loading trainees...</p>
                <div id="traineeList" class="space-y-4">
                    <!-- Trainee cards will be injected here -->
                </div>
                <p id="errorMessage" class="hidden text-center text-red-500">Error loading data. Please check your Firebase settings.</p>
            </div>
        </div>
    </div>

    <!-- Edit/Details Modal -->
    <div id="traineeModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-auto p-6 md:p-8 flex flex-col h-[90vh]">
            <div class="flex justify-between items-center pb-4 border-b flex-shrink-0">
                <h3 id="modalName" class="text-2xl font-bold text-gray-900"></h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-gray-600 font-bold text-2xl">&times;</button>
            </div>
            <div class="py-4 space-y-6 flex-1 overflow-y-auto min-h-0 custom-scrollbar">
                
                <!-- Accountability Status & Location -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="modalStatus" class="block text-sm font-medium text-gray-700">Accountability Status:</label>
                        <select id="modalStatus" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 w-full">
                            <option value="Present">Present</option>
                            <option value="Sick Call">Sick Call</option>
                            <option value="On Leave">On Leave</option>
                            <option value="Absent">Absent</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label for="traineeLocation" class="block text-sm font-medium text-gray-700">Current Location:</label>
                        <input type="text" id="traineeLocation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                </div>

                <!-- Personal Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="modalRank" class="block text-sm font-medium text-gray-700">Rank:</label>
                        <input type="text" id="modalRank" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <div class="space-y-2">
                        <label for="modalGender" class="block text-sm font-medium text-gray-700">Gender:</label>
                        <select id="modalGender" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                             <option value="Male">Male</option>
                             <option value="Female">Female</option>
                             <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <!-- Training & Fitness -->
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-bold text-gray-800">Training & Fitness</h4>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- ACFT Score -->
                        <div>
                            <label for="acftScore" class="block text-sm font-medium text-gray-700">ACFT Score:</label>
                            <select id="acftScore" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">N/A</option>
                                <option value="Pass">Pass</option>
                                <option value="Fail">Fail</option>
                            </select>
                        </div>
                        <!-- Run Time -->
                        <div>
                            <label for="runTime" class="block text-sm font-medium text-gray-700">2-Mile Run Time (e.g., 14:30):</label>
                            <input type="text" id="runTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        </div>
                        <!-- Rifle Qualification -->
                        <div>
                            <label for="rifleQual" class="block text-sm font-medium text-gray-700">Rifle Qualification:</label>
                            <select id="rifleQual" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                                <option value="">N/A</option>
                                <option value="Pass">Pass</option>
                                <option value="Fail">Fail</option>
                            </select>
                        </div>
                    </div>
                    <h5 class="text-sm font-semibold text-gray-700 mt-4">Completed Training Events:</h5>
                    <div id="trainingEventsList" class="space-y-2">
                        <!-- Checkboxes will be injected here -->
                    </div>
                </div>

                <!-- Counseling & Disciplinary Records -->
                <div class="space-y-2">
                    <h4 class="text-lg font-bold text-gray-800">Counseling & Disciplinary Records</h4>
                    <div id="counselingList" class="space-y-2">
                        <!-- Records will be injected here -->
                    </div>
                    <div class="flex space-x-2 items-end">
                        <div class="flex-1">
                            <label for="newCounselingDesc" class="block text-sm font-medium text-gray-700">New Record:</label>
                            <input type="text" id="newCounselingDesc" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <button id="addCounselingBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-blue-600 hover:bg-blue-700 whitespace-nowrap">Add</button>
                    </div>
                </div>
                
                <!-- Custom Notes -->
                <div class="space-y-2">
                    <h4 class="text-lg font-bold text-gray-800">Custom Notes</h4>
                    <div id="notesList" class="space-y-2">
                        <!-- Notes will be injected here -->
                    </div>
                    <div class="flex space-x-2 items-end">
                        <div class="flex-1">
                            <label for="newNoteText" class="block text-sm font-medium text-gray-700">New Note:</label>
                            <textarea id="newNoteText" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                        </div>
                        <div class="w-1/3">
                            <label for="newNotePriority" class="block text-sm font-medium text-gray-700">Priority:</label>
                            <select id="newNotePriority" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                        <button id="addNoteBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-blue-600 hover:bg-blue-700 whitespace-nowrap">Add</button>
                    </div>
                </div>

                <!-- Profile Data -->
                <div class="space-y-2">
                    <h4 class="text-lg font-bold text-gray-800">Medical/Physical Profile</h4>
                    <label for="profileRestriction" class="block text-sm font-medium text-gray-700">Restriction:</label>
                    <textarea id="profileRestriction" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                    <label for="profileEndDate" class="block text-sm font-medium text-gray-700">End Date:</label>
                    <input type="date" id="profileEndDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- Appointments -->
                <div class="space-y-4">
                    <h4 class="text-lg font-bold text-gray-800">Appointments</h4>
                    <div id="appointmentsList" class="space-y-2">
                        <!-- Appointments will be injected here -->
                    </div>
                    <div class="flex space-x-2 items-end">
                        <div class="flex-1">
                            <label for="newAppointmentDate" class="block text-sm font-medium text-gray-700">Date:</label>
                            <input type="date" id="newAppointmentDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="w-1/2">
                            <label for="newAppointmentTime" class="block text-sm font-medium text-gray-700">Time:</label>
                            <input type="time" id="newAppointmentTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="flex-1">
                            <label for="newAppointmentLocation" class="block text-sm font-medium text-gray-700">Location:</label>
                            <input type="text" id="newAppointmentLocation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="flex-1">
                             <label for="newAppointmentDesc" class="block text-sm font-medium text-gray-700">Description:</label>
                             <input type="text" id="newAppointmentDesc" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <button id="addAppointmentBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-blue-600 hover:bg-blue-700 whitespace-nowrap">Add</button>
                    </div>
                </div>

                <!-- History Notes -->
                <div class="space-y-2">
                    <h4 class="text-lg font-bold text-gray-800">History Notes</h4>
                    <textarea id="modalNotes" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" readonly></textarea>
                </div>
                
            </div>
            <div class="flex justify-end space-x-2 pt-4 border-t flex-shrink-0">
                <button id="updateTraineeBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 flex items-center justify-center min-w-[80px]">Update</button>
                <button id="deleteTraineeBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-red-600 hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal (replaces window.confirm) -->
    <div id="confirmModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm mx-auto p-6 md:p-8 text-center">
            <h3 id="confirmTitle" class="text-xl font-bold text-gray-900 mb-4">Are you sure?</h3>
            <p id="confirmMessage" class="text-gray-700 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmCancelBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300">Cancel</button>
                <button id="confirmProceedBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-red-600 hover:bg-red-700">Proceed</button>
            </div>
        </div>
    </div>

    <!-- Daily Check-in Modal -->
    <div id="dailyCheckInModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-auto p-6 md:p-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">Daily Accountability Check-in</h3>
            <p class="text-gray-700 mb-6">Please update the status for today's sick call and appointments.</p>
            <div id="dailyCheckInList" class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar">
                <!-- Trainees for daily check-in will be injected here -->
            </div>
            <div class="flex justify-end space-x-2 pt-4 border-t mt-4">
                <button id="skipCheckInBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300">Skip for Today</button>
                <button id="submitCheckInBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700">Submit Check-in</button>
            </div>
        </div>
    </div>
    
    <!-- Bulk Add Trainees Modal -->
    <div id="bulkAddModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto p-6 md:p-8">
            <div class="flex justify-between items-center pb-4 border-b">
                <h3 class="text-2xl font-bold text-gray-900">Bulk Add Trainees</h3>
                <button id="closeBulkAddModalBtn" class="text-gray-400 hover:text-gray-600 font-bold text-2xl">&times;</button>
            </div>
            <div class="py-4 space-y-4">
                <p class="text-gray-700">Paste your trainee data below, one per line. Format: `Rank, Name, Gender; Platoon/Company`</p>
                <textarea id="bulkTraineeInput" rows="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
            </div>
            <div class="flex justify-end pt-4 border-t">
                <button id="bulkAddCancelBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300">Cancel</button>
                <button id="bulkAddSaveBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-blue-600 hover:bg-blue-700 flex items-center justify-center min-w-[120px]">Add Trainees</button>
            </div>
        </div>
    </div>

    <!-- Manage Events Modal (Consolidated) -->
    <div id="manageEventsModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto p-6 md:p-8 flex flex-col h-[90vh]">
            <div class="flex justify-between items-center pb-4 border-b flex-shrink-0">
                <h3 class="text-2xl font-bold text-gray-900">Training Events</h3>
                <button id="closeEventsModalBtn" class="text-gray-400 hover:text-gray-600 font-bold text-2xl">&times;</button>
            </div>
            <div class="py-4 space-y-6 flex-1 overflow-y-auto min-h-0 custom-scrollbar">
                
                <!-- Section 1: Manage Events (Add/Delete) -->
                <div class="space-y-2">
                    <h4 class="text-lg font-bold text-gray-800">Define Training Events</h4>
                    <div class="flex space-x-2">
                        <input type="text" id="newTrainingEventName" placeholder="New Event Name" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <button id="addTrainingEventBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-blue-600 hover:bg-blue-700 whitespace-nowrap">Add Event</button>
                    </div>
                    <div id="trainingEventsManagementList" class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar">
                        <!-- Events will be populated here -->
                    </div>
                </div>

                <!-- Section 2: Update Events Status -->
                <div class="space-y-2">
                    <h4 class="text-lg font-bold text-gray-800">Update Event Status by Platoon</h4>
                    <p class="text-sm text-gray-600">Select an event and platoon. Deselect trainees who did NOT complete the event.</p>
                    <div class="flex space-x-2">
                        <select id="updateEventSelector" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select an Event</option>
                        </select>
                        <select id="updatePlatoonSelector" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="All">All Platoons</option>
                        </select>
                    </div>
                    <div class="mt-4 flex items-center">
                        <input type="checkbox" id="selectAllTrainees" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="selectAllTrainees" class="ml-2 block text-sm font-medium text-gray-900">Select All Trainees</label>
                    </div>
                    <div id="traineeEventUpdateList" class="space-y-2 max-h-48 overflow-y-auto mt-4 custom-scrollbar">
                        <!-- Trainees will be injected here for update -->
                    </div>
                </div>

                <!-- Section 3: View Event Status -->
                <div class="space-y-2">
                    <h4 class="text-lg font-bold text-gray-800">View Event Status</h4>
                    <p class="text-sm text-gray-600">Select a training event and platoon to view status.</p>
                    <div class="flex space-x-2">
                        <select id="viewEventSelector" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="">Select an Event</option>
                        </select>
                        <select id="viewPlatoonSelector" class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="All">All Platoons</option>
                        </select>
                    </div>
                    <div id="traineeEventViewList" class="space-y-2 max-h-48 overflow-y-auto mt-4 custom-scrollbar">
                        <!-- Trainees will be injected here for viewing status -->
                    </div>
                </div>

            </div>
            <div class="flex justify-end pt-4 border-t flex-shrink-0">
                <button id="updateTraineeEventsBtn" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 flex items-center justify-center min-w-[200px]">Update Selected Trainees</button>
            </div>
        </div>
    </div>
    
    <!-- Manage Platoon Tasks Modal -->
    <div id="manageTasksModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-75 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-auto p-6 md:p-8 flex flex-col h-[90vh]">
            <div class="flex justify-between items-center pb-4 border-b flex-shrink-0">
                <h3 class="text-2xl font-bold text-gray-900">Platoon Tasks</h3>
                <button id="closeManageTasksBtn" class="text-gray-400 hover:text-gray-600 font-bold text-2xl">&times;</button>
            </div>
            <div class="py-4 space-y-4 flex-1 overflow-y-auto min-h-0 custom-scrollbar">
                <div class="space-y-2">
                    <h4 class="text-lg font-bold text-gray-800">Add New Task</h4>
                    <div class="space-y-2">
                        <textarea id="newTaskText" rows="3" placeholder="Enter task description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                        <div class="flex flex-col sm:flex-row items-end sm:items-center space-y-2 sm:space-y-0 sm:space-x-2">
                            <div class="flex-1">
                                <label for="newTaskPriority" class="text-sm font-medium text-gray-700">Priority:</label>
                                <select id="newTaskPriority" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label for="newTaskDueDate" class="text-sm font-medium text-gray-700">Due Date:</label>
                                <input type="date" id="newTaskDueDate" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <button id="addTaskBtn" class="w-full sm:w-auto px-4 py-2 text-sm font-semibold rounded-lg text-white bg-blue-600 hover:bg-blue-700 whitespace-nowrap">Add Task</button>
                        </div>
                    </div>
                </div>
                <div class="space-y-2">
                    <h4 class="text-lg font-bold text-gray-800">Outstanding Tasks</h4>
                    <div id="tasksManagementList" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                        <!-- Tasks will be populated here -->
                    </div>
                </div>
                 <div class="space-y-2">
                    <h4 class="text-lg font-bold text-gray-800">Completed Tasks</h4>
                    <div id="completedTasksList" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                        <!-- Completed tasks will be populated here -->
                    </div>
                </div>
            </div>
            <div class="flex justify-end pt-4 border-t flex-shrink-0">
                <button id="closeTasksModal" class="px-4 py-2 text-sm font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700">Done</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, getDoc, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore debugging
        setLogLevel('debug');

        // --- GLOBAL VARIABLES & CONSTANTS ---
        // These variables are provided by the environment and are crucial for Firebase integration.
        // DO NOT HARDCODE VALUES HERE.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, traineesData = [], globalTrainingEvents = [], platoonTasks = [];
        let unsubscribeTrainees, unsubscribeEvents, unsubscribeTasks; // To manage listeners

        // --- UI ELEMENT SELECTORS ---
        const authStatusEl = document.getElementById('authStatus');
        const userIdDisplayEl = document.getElementById('userIdDisplay');
        const availableCountEl = document.getElementById('availableCount');
        const dashboardPlatoonFilterEl = document.getElementById('dashboardPlatoonFilter');
        const rosterCountEl = document.getElementById('rosterCount');
        const presentCountEl = document.getElementById('presentCount');
        const sickCallCountEl = document.getElementById('sickCallCount');
        const profileCountEl = document.getElementById('profileCount');
        const unqualifiedCountEl = document.getElementById('unqualifiedCount');
        const acftFailCountEl = document.getElementById('acftFailCount');
        const upcomingAppointmentsListEl = document.getElementById('upcomingAppointmentsList');
        const priorityListEl = document.getElementById('priorityList');
        const dashboardCards = document.querySelectorAll('[data-filter]');
        const maleCountEl = document.getElementById('maleCount');
        const femaleCountEl = document.getElementById('femaleCount');

        const addTraineeBtn = document.getElementById('addTraineeBtn');
        const bulkAddBtn = document.getElementById('bulkAddBtn');
        const resetAppBtn = document.getElementById('resetAppBtn');
        const addTraineeFormContainer = document.getElementById('addTraineeFormContainer');
        const cancelAddBtn = document.getElementById('cancelAddBtn');
        const traineeForm = document.getElementById('traineeForm');
        const traineeList = document.getElementById('traineeList');
        const loadingStatusEl = document.getElementById('loadingStatus');
        const errorMessageEl = document.getElementById('errorMessage');
        const rosterHeaderEl = document.getElementById('rosterHeader');

        const traineeModal = document.getElementById('traineeModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalNameEl = document.getElementById('modalName');
        const modalStatusEl = document.getElementById('modalStatus');
        const traineeLocationEl = document.getElementById('traineeLocation');
        const modalRankEl = document.getElementById('modalRank');
        const modalGenderEl = document.getElementById('modalGender');
        const acftScoreEl = document.getElementById('acftScore');
        const runTimeEl = document.getElementById('runTime');
        const rifleQualEl = document.getElementById('rifleQual');
        const trainingEventsListEl = document.getElementById('trainingEventsList');
        const counselingListEl = document.getElementById('counselingList');
        const newCounselingDescEl = document.getElementById('newCounselingDesc');
        const addCounselingBtn = document.getElementById('addCounselingBtn');
        const profileRestrictionEl = document.getElementById('profileRestriction');
        const profileEndDateEl = document.getElementById('profileEndDate');
        const appointmentsListEl = document.getElementById('appointmentsList');
        const newAppointmentDateEl = document.getElementById('newAppointmentDate');
        const newAppointmentTimeEl = document.getElementById('newAppointmentTime');
        const newAppointmentLocationEl = document.getElementById('newAppointmentLocation');
        const newAppointmentDescEl = document.getElementById('newAppointmentDesc');
        const addAppointmentBtn = document.getElementById('addAppointmentBtn');
        const modalNotesEl = document.getElementById('modalNotes');
        const updateTraineeBtn = document.getElementById('updateTraineeBtn');
        const deleteTraineeBtn = document.getElementById('deleteTraineeBtn');
        
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitleEl = document.getElementById('confirmTitle');
        const confirmMessageEl = document.getElementById('confirmMessage');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const confirmProceedBtn = document.getElementById('confirmProceedBtn');
        
        const notificationBanner = document.getElementById('notificationBanner');
        const notificationMessageEl = document.getElementById('notificationMessage');

        const dailyCheckInModal = document.getElementById('dailyCheckInModal');
        const dailyCheckInListEl = document.getElementById('dailyCheckInList');
        const skipCheckInBtn = document.getElementById('skipCheckInBtn');
        const submitCheckInBtn = document.getElementById('submitCheckInBtn');

        const manageEventsModal = document.getElementById('manageEventsModal');
        const openEventsModalBtn = document.getElementById('openEventsModal');
        const closeEventsModalBtn = document.getElementById('closeEventsModalBtn');
        const newTrainingEventNameEl = document.getElementById('newTrainingEventName');
        const addTrainingEventBtn = document.getElementById('addTrainingEventBtn');
        const trainingEventsManagementListEl = document.getElementById('trainingEventsManagementList');
        const updateEventSelectorEl = document.getElementById('updateEventSelector');
        const updatePlatoonSelectorEl = document.getElementById('updatePlatoonSelector');
        const traineeEventUpdateListEl = document.getElementById('traineeEventUpdateList');
        const updateTraineeEventsBtn = document.getElementById('updateTraineeEventsBtn');
        const selectAllTraineesCheckbox = document.getElementById('selectAllTrainees');
        const viewEventSelectorEl = document.getElementById('viewEventSelector');
        const viewPlatoonSelectorEl = document.getElementById('viewPlatoonSelector');
        const traineeEventViewListEl = document.getElementById('traineeEventViewList');

        const traineeSearchEl = document.getElementById('traineeSearch');
        const platoonFilterEl = document.getElementById('platoonFilter');

        const bulkAddModal = document.getElementById('bulkAddModal');
        const closeBulkAddModalBtn = document.getElementById('closeBulkAddModalBtn');
        const bulkAddCancelBtn = document.getElementById('bulkAddCancelBtn');
        const bulkAddSaveBtn = document.getElementById('bulkAddSaveBtn');
        const bulkTraineeInput = document.getElementById('bulkTraineeInput');

        const notesListEl = document.getElementById('notesList');
        const newNoteTextEl = document.getElementById('newNoteText');
        const newNotePriorityEl = document.getElementById('newNotePriority');
        const addNoteBtn = document.getElementById('addNoteBtn');
        
        const openTasksModalBtn = document.getElementById('openTasksModal');
        const manageTasksModal = document.getElementById('manageTasksModal');
        const closeManageTasksBtn = document.getElementById('closeManageTasksBtn');
        const closeTasksModalBtn = document.getElementById('closeTasksModal');
        const newTaskTextEl = document.getElementById('newTaskText');
        const newTaskPriorityEl = document.getElementById('newTaskPriority');
        const newTaskDueDateEl = document.getElementById('newTaskDueDate');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const tasksManagementListEl = document.getElementById('tasksManagementList');
        const completedTasksListEl = document.getElementById('completedTasksList');
        const outstandingTasksCount = document.getElementById('outstandingTasksCount');

        let currentEditingTraineeId = null;
        let platoons = new Set();
        let currentStatusFilter = 'All';
        let currentPlatoonFilter = 'All';

        // --- HELPER FUNCTIONS ---

        const setButtonLoading = (button, isLoading) => {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `<div class="spinner mx-auto"></div>`;
            } else {
                button.disabled = false;
                button.innerHTML = button.dataset.originalText || 'Submit';
            }
        };

        const formatDate = (date) => {
            if (!date) return 'N/A';
            let d = date;
            if (typeof date === 'string') {
                d = new Date(date);
            } else if (date && typeof date.toDate === 'function') {
                d = date.toDate();
            }
            // Add one day to correct for timezone issues with date inputs
            d.setDate(d.getDate() + 1);
            return d.toLocaleDateString();
        };

        const formatTimestamp = (timestamp) => {
            if (timestamp && typeof timestamp.toDate === 'function') {
                return timestamp.toDate().toLocaleString();
            }
            // Handle ISO string format
            if (typeof timestamp === 'string') {
                return new Date(timestamp).toLocaleString();
            }
            return new Date().toLocaleString();
        };

        const showConfirmation = (title, message, onConfirm) => {
            confirmTitleEl.textContent = title;
            confirmMessageEl.textContent = message;
            confirmModal.classList.remove('hidden');
            document.body.classList.add('modal-open');

            const handleProceed = () => {
                onConfirm();
                closeConfirmation();
            };

            const closeConfirmation = () => {
                 confirmModal.classList.add('hidden');
                 document.body.classList.remove('modal-open');
                 confirmProceedBtn.removeEventListener('click', handleProceed);
                 confirmCancelBtn.removeEventListener('click', closeConfirmation);
            }
            
            confirmProceedBtn.addEventListener('click', handleProceed);
            confirmCancelBtn.addEventListener('click', closeConfirmation);
        };
        
        // --- FIREBASE & AUTH INITIALIZATION ---
        window.onload = function() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. App cannot start.");
                authStatusEl.textContent = 'Status: Error';
                userIdDisplayEl.textContent = 'Firebase configuration not found.';
                loadingStatusEl.textContent = 'App initialization failed.';
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = 'Status: Authenticated';
                        userIdDisplayEl.textContent = `User ID: ${userId}`;
                        setupRealtimeListeners();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            authStatusEl.textContent = 'Status: Authentication Failed';
                            userId = `temp-user-${crypto.randomUUID()}`;
                            userIdDisplayEl.textContent = `Using temporary ID: ${userId}`;
                            setupRealtimeListeners(); // Still setup listeners with temp ID if auth fails
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                authStatusEl.textContent = 'Status: Error';
                userIdDisplayEl.textContent = 'Could not initialize Firebase.';
            }
        };

        // --- REAL-TIME LISTENERS ---
        const setupRealtimeListeners = () => {
             // Detach old listeners if they exist to prevent memory leaks
            if (unsubscribeTrainees) unsubscribeTrainees();
            if (unsubscribeEvents) unsubscribeEvents();
            if (unsubscribeTasks) unsubscribeTasks();
            
            const traineesColRef = collection(db, `artifacts/${appId}/users/${userId}/trainees`);
            const qTrainees = query(traineesColRef);
            const eventsColRef = collection(db, `artifacts/${appId}/users/${userId}/training_events`);
            const qEvents = query(eventsColRef);
            const tasksColRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
            const qTasks = query(tasksColRef);
        
            unsubscribeEvents = onSnapshot(qEvents, (snapshot) => {
                globalTrainingEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                totalEventsCount.textContent = globalTrainingEvents.length;
                populateTrainingEventSelectors();
            }, (error) => {
                console.error("Error fetching global training events:", error);
                errorMessageEl.classList.remove('hidden');
                loadingStatusEl.classList.add('hidden');
            });
        
            unsubscribeTrainees = onSnapshot(qTrainees, (snapshot) => {
                loadingStatusEl.style.display = 'none';
                errorMessageEl.classList.add('hidden');
                traineesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                platoons.clear();
                traineesData.forEach(trainee => platoons.add(trainee.platoon));
                
                updateDashboardCounts();
                populatePlatoonFilters();
                renderTraineeList();
                checkForUpcomingAppointments();
                updateDashboardNotesAndTasks();
                performDailyCheckIn();
            }, (error) => {
                console.error("Error fetching trainees:", error);
                loadingStatusEl.style.display = 'none';
                errorMessageEl.classList.remove('hidden');
                traineeList.innerHTML = '';
            });

            unsubscribeTasks = onSnapshot(qTasks, (snapshot) => {
                platoonTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboardTasks();
                renderTasksManagementList();
                updateDashboardNotesAndTasks();
            }, (error) => {
                console.error("Error fetching platoon tasks:", error);
            });
        };

        // --- DASHBOARD & UI UPDATES ---
        const updateDashboardCounts = () => {
            const statusCounts = { 'Present': 0, 'Sick Call': 0, 'On Leave': 0, 'Absent': 0, 'Other': 0 };
            let profileCount = 0;
            let unqualifiedCount = 0;
            let acftFailCount = 0;
            let maleCount = 0;
            let femaleCount = 0;

            traineesData.forEach(trainee => {
                statusCounts[trainee.status in statusCounts ? trainee.status : 'Other']++;
                if (trainee.profile?.restriction) profileCount++;
                if (trainee.fitness?.rifleQual === 'Fail') unqualifiedCount++;
                if (trainee.fitness?.acftScore === 'Fail') acftFailCount++;
                if (trainee.gender === 'Male') maleCount++;
                else if (trainee.gender === 'Female') femaleCount++;
            });

            rosterCountEl.textContent = traineesData.length;
            presentCountEl.textContent = statusCounts['Present'];
            sickCallCountEl.textContent = statusCounts['Sick Call'];
            profileCountEl.textContent = profileCount;
            unqualifiedCountEl.textContent = unqualifiedCount;
            acftFailCountEl.textContent = acftFailCount;
            maleCountEl.textContent = maleCount;
            femaleCountEl.textContent = femaleCount;

            updateAvailableTraineeCount(dashboardPlatoonFilterEl.value);
        }

        dashboardCards.forEach(card => {
            card.addEventListener('click', () => {
                const filter = card.dataset.filter;
                currentStatusFilter = filter;
                traineeSearchEl.value = ''; // Reset search bar
                handlePlatoonFilterChange('All'); // This resets platoon filters and re-renders the list
                updateRosterHeader(filter); // This updates the header text
            });
        });

        const updateRosterHeader = (filter) => {
            const filterMap = {
                'All': 'Trainee Roster',
                'Profile': 'Trainees on Profile',
                'Unqualified': 'Unqualified Trainees',
                'ACFT Fail': 'ACFT Failures',
                'Male': 'Male Trainees',
                'Female': 'Female Trainees',
                'Other': 'Other Gender Trainees',
            };
            rosterHeaderEl.textContent = filterMap[filter] || `Trainees with Status: ${filter}`;
        };

        const updateAvailableTraineeCount = (platoon) => {
            let filteredTrainees = platoon === 'All' ? traineesData : traineesData.filter(t => t.platoon === platoon);
            const totalCount = filteredTrainees.length;
            const availableCount = filteredTrainees.filter(t => t.status === 'Present').length;
            
            availableCountEl.textContent = `${availableCount} / ${totalCount} Trainees Available`;
        };

        const checkForUpcomingAppointments = () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tenDaysFromNow = new Date(today);
            tenDaysFromNow.setDate(today.getDate() + 10);
            
            const upcoming = [];
            
            traineesData.forEach(trainee => {
                (trainee.appointments || []).forEach(app => {
                    const appDate = new Date(app.date);
                    if (appDate >= today && appDate <= tenDaysFromNow) {
                        const daysLeft = Math.ceil((appDate - today) / (1000 * 60 * 60 * 24));
                        upcoming.push({ name: trainee.name, description: app.description, daysLeft });
                    }
                });
            });
            
            if (upcoming.length > 0) {
                const message = upcoming.map(item => {
                    const daysText = item.daysLeft === 0 ? 'today' : `${item.daysLeft} day${item.daysLeft === 1 ? '' : 's'}`;
                    return `${item.name}: ${item.description} (${daysText})`;
                }).join('; ');
                
                notificationMessageEl.textContent = `Upcoming Appointments: ${message}.`;
                notificationBanner.classList.remove('hidden');
            } else {
                notificationBanner.classList.add('hidden');
            }

            upcomingAppointmentsListEl.innerHTML = '';
            if (upcoming.length > 0) {
                upcoming.forEach(app => {
                    const li = document.createElement('li');
                    li.textContent = `${app.name}: ${app.description}`;
                    upcomingAppointmentsListEl.appendChild(li);
                });
            } else {
                upcomingAppointmentsListEl.innerHTML = '<li>No upcoming appointments in the next 10 days.</li>';
            }
        };

        const updateDashboardNotesAndTasks = () => {
            const priorityOrder = { 'High': 1, 'Medium': 2, 'Low': 3 };
            const allItems = [];
            const today = new Date();

            traineesData.forEach(trainee => {
                (trainee.customNotes || []).forEach(note => allItems.push({
                    type: 'Note', name: trainee.name, priority: note.priority, text: note.text, timestamp: note.timestamp
                }));
            });

            platoonTasks.forEach(task => {
                if (!task.completed) {
                    let taskPriority = task.priority;
                    if (task.dueDate) {
                        const dueDate = new Date(task.dueDate);
                        const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                        if (diffDays <= 3) taskPriority = 'High';
                        else if (diffDays <= 7) taskPriority = 'Medium';
                    }
                    allItems.push({ type: 'Task', id: task.id, priority: taskPriority, text: task.text, dueDate: task.dueDate });
                }
            });

            allItems.sort((a, b) => {
                const priorityA = priorityOrder[a.priority];
                const priorityB = priorityOrder[b.priority];
                if (priorityA !== priorityB) return priorityA - priorityB;
                
                const dateA = a.dueDate ? new Date(a.dueDate).getTime() : (a.timestamp ? a.timestamp.toMillis() : Infinity);
                const dateB = b.dueDate ? new Date(b.dueDate).getTime() : (b.timestamp ? b.timestamp.toMillis() : Infinity);
                return dateA - dateB;
            });

            priorityListEl.innerHTML = allItems.map(item => {
                const isTask = item.type === 'Task';
                const dueDateText = isTask && item.dueDate ? ` (Due: ${formatDate(item.dueDate)})` : '';
                const priorityClass = {
                    'High': 'bg-red-200 text-red-800',
                    'Medium': 'bg-yellow-200 text-yellow-800',
                    'Low': 'bg-gray-200 text-gray-800'
                }[item.priority];
                return `<li>
                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${priorityClass}">${item.priority}</span>
                    <span class="ml-2">${isTask ? 'TASK' : item.name}: ${item.text}${dueDateText}</span>
                </li>`;
            }).join('') || '<li>No priority items at this time.</li>';
        };


        // --- MAIN TRAINEE LIST RENDERING ---
        const renderTraineeList = () => {
            const searchTerm = traineeSearchEl.value.toLowerCase();
            const selectedPlatoon = currentPlatoonFilter;

            let filteredTrainees = traineesData.filter(trainee => {
                const nameMatch = trainee.name.toLowerCase().includes(searchTerm);
                const platoonMatch = selectedPlatoon === 'All' || trainee.platoon === selectedPlatoon;
                
                let statusMatch = true;
                if (currentStatusFilter !== 'All') {
                    if (currentStatusFilter === 'Profile') statusMatch = !!trainee.profile?.restriction;
                    else if (currentStatusFilter === 'Unqualified') statusMatch = trainee.fitness?.rifleQual === 'Fail';
                    else if (currentStatusFilter === 'ACFT Fail') statusMatch = trainee.fitness?.acftScore === 'Fail';
                    else if (['Male', 'Female', 'Other'].includes(currentStatusFilter)) statusMatch = trainee.gender === currentStatusFilter;
                    else statusMatch = trainee.status === currentStatusFilter;
                }
                return nameMatch && platoonMatch && statusMatch;
            });
            
            filteredTrainees.sort((a, b) => a.platoon.localeCompare(b.platoon) || a.name.localeCompare(b.name));

            traineeList.innerHTML = '';
            if (filteredTrainees.length === 0) {
                traineeList.innerHTML = '<p class="text-center text-gray-500">No matching trainees found.</p>';
            } else {
                filteredTrainees.forEach(trainee => traineeList.appendChild(createTraineeCard(trainee)));
            }
        };

        const createTraineeCard = (trainee) => {
            const card = document.createElement('div');
            card.className = 'bg-gray-50 p-4 rounded-lg shadow-sm cursor-pointer hover:bg-gray-100 transition-colors';
            card.dataset.id = trainee.id;

            const { profile = {}, fitness = {}, appointments = [], history = [], customNotes = [] } = trainee;
            const sickCallCount = (history || []).filter(item => item.details.includes('to \'Sick Call\'')).length;
            const hasUpcomingAppointment = (appointments || []).some(app => new Date(app.date) >= new Date());
            const hasTaggedNote = (customNotes || []).some(note => note.text.toLowerCase().includes(`@${trainee.name.toLowerCase()}`));

            const statusClass = {
                'Present': 'bg-green-100 text-green-800',
                'Sick Call': 'bg-yellow-100 text-yellow-800',
                'On Leave': 'bg-blue-100 text-blue-800',
            }[trainee.status] || 'bg-red-100 text-red-800';

            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-xl font-semibold text-gray-900">${trainee.rank || ''} ${trainee.name}</h4>
                    <span class="px-3 py-1 text-sm font-medium rounded-full ${statusClass}">${trainee.status}</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">Platoon: ${trainee.platoon} | Gender: ${trainee.gender}</p>
                <div class="flex flex-wrap items-center gap-2 text-xs">
                    ${profile.restriction ? `<span title="${profile.restriction}" class="bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">PROFILE</span>` : ''}
                    ${fitness.acftScore === 'Fail' ? `<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">ACFT FAIL</span>` : ''}
                    ${fitness.rifleQual === 'Fail' ? `<span class="bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">RIFLE FAIL</span>` : ''}
                    ${hasUpcomingAppointment ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-medium">APPT</span>` : ''}
                    ${sickCallCount > 0 ? `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">${sickCallCount}x SICK CALL</span>` : ''}
                    ${hasTaggedNote ? `<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full font-medium">TAGGED</span>` : ''}
                </div>
            `;
            card.addEventListener('click', () => showTraineeModal(trainee));
            return card;
        };
        
        // --- MODAL MANAGEMENT ---

        const showTraineeModal = (trainee) => {
            currentEditingTraineeId = trainee.id;
            modalNameEl.textContent = trainee.name;
            modalStatusEl.value = trainee.status;
            traineeLocationEl.value = trainee.location || '';
            modalRankEl.value = trainee.rank || '';
            modalGenderEl.value = trainee.gender || 'Other';

            const { profile = {}, fitness = {}, appointments = [], history = [], counselingHistory = [], customNotes = [], trainingEvents = [] } = trainee;

            acftScoreEl.value = fitness.acftScore || '';
            runTimeEl.value = fitness.runTime || '';
            rifleQualEl.value = fitness.rifleQual || '';
            profileRestrictionEl.value = profile.restriction || '';
            profileEndDateEl.value = profile.endDate || '';

            trainingEventsListEl.innerHTML = globalTrainingEvents.map(event => `
                <div class="flex items-center">
                    <input type="checkbox" id="event-${event.id}" data-event-id="${event.id}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${trainingEvents.includes(event.id) ? 'checked' : ''}>
                    <label for="event-${event.id}" class="ml-2 block text-sm text-gray-900">${event.name}</label>
                </div>
            `).join('');
            
            modalNotesEl.value = (history || []).map(item => `[${formatTimestamp(item.timestamp)}] ${item.type}: ${item.details}`).join('\n');
            
            renderDynamicList(counselingListEl, counselingHistory, (record, index) => `
                <span>[${formatTimestamp(record.timestamp)}] ${record.details}</span>`, 'delete-counseling', index);

            renderDynamicList(notesListEl, customNotes, (note, index) => `
                <div class="flex-1 space-y-1">
                    <div class="flex items-center">
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${
                            note.priority === 'High' ? 'bg-red-200 text-red-800' :
                            note.priority === 'Medium' ? 'bg-yellow-200 text-yellow-800' :
                            'bg-gray-200 text-gray-800'
                        }">${note.priority}</span>
                        <span class="ml-2 text-gray-700">${note.text}</span>
                    </div>
                    <p class="text-xs text-gray-500">${formatTimestamp(note.timestamp)}</p>
                </div>`, 'delete-note', index);

            renderDynamicList(appointmentsListEl, appointments, (app, index) => `
                <div class="flex-1">
                    <span class="font-semibold">${formatDate(app.date)} @ ${app.time} - ${app.location}:</span>
                    <span>${app.description}</span>
                </div>`, 'delete-appointment', index);


            traineeModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
        };

        const renderDynamicList = (element, items, renderFn, deleteClass, indexKey) => {
            element.innerHTML = (items || []).map((item, index) => `
                <div class="p-2 bg-gray-100 rounded-lg text-sm flex justify-between items-start">
                    ${renderFn(item, index)}
                    <button class="text-red-500 hover:text-red-700 ml-2 ${deleteClass}" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            `).join('');
        };
        
        // --- DATA MANIPULATION (ADD/UPDATE/DELETE) ---

        traineeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(traineeForm);
            const newTraineeData = {
                name: formData.get('name').trim(),
                platoon: formData.get('platoon').trim(),
                rank: formData.get('rank').trim(),
                gender: formData.get('gender').trim(),
                status: 'Present',
                location: '',
                history: [{ type: 'Added', details: 'Trainee added to the roster.', timestamp: Timestamp.now() }],
                profile: { restriction: '', endDate: '' },
                appointments: [],
                fitness: { acftScore: '', runTime: '', rifleQual: '' },
                counselingHistory: [],
                trainingEvents: [],
                customNotes: []
            };
            if (!newTraineeData.name || !newTraineeData.platoon || !newTraineeData.rank || !newTraineeData.gender) return;

            try {
                const traineesColRef = collection(db, `artifacts/${appId}/users/${userId}/trainees`);
                await addDoc(traineesColRef, newTraineeData);
                traineeForm.reset();
                addTraineeFormContainer.classList.add('hidden');
            } catch (error) {
                console.error("Error adding trainee:", error);
            }
        });

        const addDynamicItem = async (fieldName, newItem) => {
            if (!currentEditingTraineeId) return;
            const traineeDocRef = doc(db, `artifacts/${appId}/users/${userId}/trainees/${currentEditingTraineeId}`);
            try {
                const traineeDocSnap = await getDoc(traineeDocRef);
                if (traineeDocSnap.exists()) {
                    const currentData = traineeDocSnap.data();
                    const items = currentData[fieldName] || [];
                    items.push(newItem);
                    await setDoc(traineeDocRef, { [fieldName]: items }, { merge: true });
                }
            } catch (error) {
                console.error(`Error adding ${fieldName}:`, error);
            }
        }
        
        const deleteDynamicItem = async (fieldName, index) => {
            if (!currentEditingTraineeId) return;
            const traineeDocRef = doc(db, `artifacts/${appId}/users/${userId}/trainees/${currentEditingTraineeId}`);
            try {
                const traineeDocSnap = await getDoc(traineeDocRef);
                if (traineeDocSnap.exists()) {
                    const currentData = traineeDocSnap.data();
                    const items = currentData[fieldName] || [];
                    items.splice(index, 1);
                    await setDoc(traineeDocRef, { [fieldName]: items }, { merge: true });
                }
            } catch (error) {
                console.error(`Error deleting ${fieldName}:`, error);
            }
        }

        addAppointmentBtn.addEventListener('click', () => {
            const appointment = {
                date: newAppointmentDateEl.value,
                time: newAppointmentTimeEl.value,
                location: newAppointmentLocationEl.value.trim(),
                description: newAppointmentDescEl.value.trim()
            };
            if (appointment.date && appointment.time && appointment.location && appointment.description) {
                addDynamicItem('appointments', appointment);
                newAppointmentDateEl.value = newAppointmentTimeEl.value = newAppointmentLocationEl.value = newAppointmentDescEl.value = '';
            }
        });

        addCounselingBtn.addEventListener('click', () => {
            const desc = newCounselingDescEl.value.trim();
            if (desc) {
                addDynamicItem('counselingHistory', { timestamp: Timestamp.now(), details: desc });
                newCounselingDescEl.value = '';
            }
        });

        addNoteBtn.addEventListener('click', () => {
            const note = {
                text: newNoteTextEl.value.trim(),
                priority: newNotePriorityEl.value,
                timestamp: Timestamp.now()
            };
            if (note.text) {
                addDynamicItem('customNotes', note);
                newNoteTextEl.value = '';
                newNotePriorityEl.value = 'Low';
            }
        });

        traineeModal.addEventListener('click', (e) => {
            if (e.target.matches('.delete-counseling')) {
                showConfirmation("Delete Record", "Are you sure?", () => deleteDynamicItem('counselingHistory', e.target.dataset.index));
            } else if (e.target.matches('.delete-note')) {
                 showConfirmation("Delete Note", "Are you sure?", () => deleteDynamicItem('customNotes', e.target.dataset.index));
            } else if (e.target.matches('.delete-appointment')) {
                showConfirmation("Delete Appointment", "Are you sure?", () => deleteDynamicItem('appointments', e.target.dataset.index));
            }
        });

        updateTraineeBtn.addEventListener('click', async () => {
            if (!currentEditingTraineeId) return;
            
            setButtonLoading(updateTraineeBtn, true);

            const trainee = traineesData.find(t => t.id === currentEditingTraineeId);
            const history = trainee.history || [];
            history.push({ type: 'Updated', details: 'Data updated via modal.', timestamp: Timestamp.now() });

            const completedTrainingEvents = Array.from(trainingEventsListEl.querySelectorAll('input:checked')).map(cb => cb.dataset.eventId);

            const updatedData = {
                status: modalStatusEl.value,
                location: traineeLocationEl.value.trim(),
                rank: modalRankEl.value.trim(),
                gender: modalGenderEl.value,
                history: history,
                profile: {
                    restriction: profileRestrictionEl.value.trim(),
                    endDate: profileEndDateEl.value
                },
                fitness: {
                    acftScore: acftScoreEl.value,
                    runTime: runTimeEl.value.trim(),
                    rifleQual: rifleQualEl.value
                },
                trainingEvents: completedTrainingEvents,
                updatedAt: Timestamp.now()
            };

            try {
                const traineeDocRef = doc(db, `artifacts/${appId}/users/${userId}/trainees/${currentEditingTraineeId}`);
                await setDoc(traineeDocRef, updatedData, { merge: true });
                traineeModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            } catch (error) {
                console.error("Error updating trainee:", error);
            } finally {
                setButtonLoading(updateTraineeBtn, false);
            }
        });
        
        deleteTraineeBtn.addEventListener('click', async () => {
            if (!currentEditingTraineeId) return;
            showConfirmation("Delete Trainee", "Are you sure? This action is permanent.", async () => {
                try {
                    const traineeDocRef = doc(db, `artifacts/${appId}/users/${userId}/trainees/${currentEditingTraineeId}`);
                    await deleteDoc(traineeDocRef);
                    traineeModal.classList.add('hidden');
                    currentEditingTraineeId = null;
                    document.body.classList.remove('modal-open');
                } catch (error) {
                    console.error("Error deleting trainee:", error);
                }
            });
        });
        
        // --- BULK ADD LOGIC ---
        bulkAddSaveBtn.addEventListener('click', async () => {
             setButtonLoading(bulkAddSaveBtn, true);
             const lines = bulkTraineeInput.value.trim().split('\n');
             const traineesColRef = collection(db, `artifacts/${appId}/users/${userId}/trainees`);

             for (const line of lines) {
                const parts = line.split(';');
                if (parts.length >= 2) {
                    const [rank, name, gender] = parts[0].trim().split(',').map(s => s.trim());
                    const platoon = parts[1].trim();

                    if (rank && name && gender && platoon) {
                         const newTraineeData = {
                            name, platoon, rank, gender, status: 'Present', location: '',
                            history: [{ type: 'Added', details: 'Trainee added via bulk upload.', timestamp: Timestamp.now() }],
                            profile: { restriction: '', endDate: '' }, appointments: [], fitness: {}, counselingHistory: [], trainingEvents: [], customNotes: []
                        };
                        try {
                           await addDoc(traineesColRef, newTraineeData);
                        } catch (e) {
                           console.error("Failed to add trainee:", name, e);
                        }
                    }
                }
             }
             bulkAddModal.classList.add('hidden');
             bulkTraineeInput.value = '';
             document.body.classList.remove('modal-open');
             setButtonLoading(bulkAddSaveBtn, false);
        });

        // --- MANAGE EVENTS LOGIC ---
        addTrainingEventBtn.addEventListener('click', async () => {
            const newEventName = newTrainingEventNameEl.value.trim();
            if (newEventName) {
                 try {
                    const eventsColRef = collection(db, `artifacts/${appId}/users/${userId}/training_events`);
                    await addDoc(eventsColRef, { name: newEventName });
                    newTrainingEventNameEl.value = '';
                } catch (error) { console.error("Error adding training event:", error); }
            }
        });

        updateTraineeEventsBtn.addEventListener('click', async () => {
            const selectedEventId = updateEventSelectorEl.value;
            if (!selectedEventId) return;
            setButtonLoading(updateTraineeEventsBtn, true);

            const traineeCheckboxes = traineeEventUpdateListEl.querySelectorAll('input[type="checkbox"]');
            for (const checkbox of traineeCheckboxes) {
                const traineeId = checkbox.dataset.traineeId;
                const trainee = traineesData.find(t => t.id === traineeId);
                if (!trainee) continue;
                
                let completedEvents = trainee.trainingEvents || [];
                const hasCompleted = completedEvents.includes(selectedEventId);
                const isChecked = checkbox.checked;
                
                let needsUpdate = false;
                if (isChecked && !hasCompleted) {
                    completedEvents.push(selectedEventId);
                    needsUpdate = true;
                } else if (!isChecked && hasCompleted) {
                    completedEvents = completedEvents.filter(id => id !== selectedEventId);
                    needsUpdate = true;
                }

                if (needsUpdate) {
                     try {
                        const traineeDocRef = doc(db, `artifacts/${appId}/users/${userId}/trainees/${traineeId}`);
                        await setDoc(traineeDocRef, { trainingEvents: completedEvents }, { merge: true });
                    } catch (error) { console.error(`Error updating trainee ${traineeId}:`, error); }
                }
            }
            manageEventsModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
            setButtonLoading(updateTraineeEventsBtn, false);
        });
        
        // --- EVENT LISTENERS ---
        // Store original button text for loading state
        document.querySelectorAll('button').forEach(btn => {
            if (btn.id === 'updateTraineeBtn' || btn.id === 'bulkAddSaveBtn' || btn.id === 'updateTraineeEventsBtn') {
                 btn.dataset.originalText = btn.textContent;
            }
        });
        
        // General UI listeners
        traineeSearchEl.addEventListener('input', renderTraineeList);
        platoonFilterEl.addEventListener('change', (e) => handlePlatoonFilterChange(e.target.value));
        dashboardPlatoonFilterEl.addEventListener('change', (e) => handlePlatoonFilterChange(e.target.value));
        updatePlatoonSelectorEl.addEventListener('change', (e) => handlePlatoonFilterChange(e.target.value));
        viewPlatoonSelectorEl.addEventListener('change', (e) => handlePlatoonFilterChange(e.target.value));

        // Listeners for event dropdowns in the modal to re-render their respective lists
        updateEventSelectorEl.addEventListener('change', renderTraineeEventUpdateList);
        viewEventSelectorEl.addEventListener('change', renderTraineeEventViewList);


        // Event listeners for opening/closing modals
        const modalTriggers = {
            'addTraineeBtn': addTraineeFormContainer,
            'bulkAddBtn': bulkAddModal,
            'openEventsModal': manageEventsModal,
            'openTasksModal': manageTasksModal,
        };
        const modalClosers = {
            'cancelAddBtn': addTraineeFormContainer,
            'closeBulkAddModalBtn': bulkAddModal,
            'bulkAddCancelBtn': bulkAddModal,
            'closeEventsModalBtn': manageEventsModal,
            'closeManageTasksBtn': manageTasksModal,
            'closeTasksModal': manageTasksModal,
            'closeModalBtn': traineeModal
        };

        Object.entries(modalTriggers).forEach(([btnId, modal]) => {
            document.getElementById(btnId).addEventListener('click', () => {
                modal.classList.remove('hidden');
                document.body.classList.add('modal-open');
            });
        });

        Object.entries(modalClosers).forEach(([btnId, modal]) => {
            document.getElementById(btnId).addEventListener('click', () => {
                modal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            });
        });
        
        // Close modal on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    document.body.classList.remove('modal-open');
                }
            });
        });

        // --- PLATOON FILTER SYNCHRONIZATION ---
        const handlePlatoonFilterChange = (platoon) => {
            currentPlatoonFilter = platoon;
            
            // Synchronize all dropdowns
            dashboardPlatoonFilterEl.value = platoon;
            platoonFilterEl.value = platoon;
            updatePlatoonSelectorEl.value = platoon;
            viewPlatoonSelectorEl.value = platoon;
            
            // Update relevant parts of the UI
            updateAvailableTraineeCount(platoon);
            renderTraineeList();
            
            // These will be called, but the rendering inside will depend on other selections (like event)
            renderTraineeEventUpdateList();
            renderTraineeEventViewList();
        };

        // --- DATA & UI POPULATION ---
        const populatePlatoonFilters = () => {
            const sortedPlatoons = Array.from(platoons).sort();
            const platoonOptions = sortedPlatoons.map(p => `<option value="${p}">${p}</option>`).join('');

            dashboardPlatoonFilterEl.innerHTML = '<option value="All">All Platoons</option>' + platoonOptions;
            platoonFilterEl.innerHTML = '<option value="All">All Platoons</option>' + platoonOptions;
            updatePlatoonSelectorEl.innerHTML = '<option value="All">Entire Company Roster</option>' + platoonOptions;
            viewPlatoonSelectorEl.innerHTML = '<option value="All">All Platoons</option>' + platoonOptions;

            // Sync all to the global filter
            dashboardPlatoonFilterEl.value = currentPlatoonFilter;
            platoonFilterEl.value = currentPlatoonFilter;
            updatePlatoonSelectorEl.value = currentPlatoonFilter;
            viewPlatoonSelectorEl.value = currentPlatoonFilter;
        };

        const populateTrainingEventSelectors = () => {
            const trainingEventOptions = globalTrainingEvents.map(event => `<option value="${event.id}">${event.name}</option>`).join('');
            updateEventSelectorEl.innerHTML = '<option value="">Select an Event</option>' + trainingEventOptions;
            viewEventSelectorEl.innerHTML = '<option value="">Select an Event</option>' + trainingEventOptions;
        };

        const renderTraineeEventUpdateList = () => {
            const selectedEventId = updateEventSelectorEl.value;
            const selectedPlatoon = currentPlatoonFilter;
            traineeEventUpdateListEl.innerHTML = '';
            
            if (!selectedEventId) {
                traineeEventUpdateListEl.innerHTML = '<p class="text-center text-gray-500">Please select a training event.</p>';
                return;
            }
            
            let filteredTrainees = traineesData;
            if (selectedPlatoon !== 'All') {
                filteredTrainees = traineesData.filter(trainee => trainee.platoon === selectedPlatoon);
            }

            if (filteredTrainees.length === 0) {
                 traineeEventUpdateListEl.innerHTML = '<p class="text-center text-gray-500">No trainees found for this platoon.</p>';
                 return;
            }

            filteredTrainees.sort((a, b) => a.name.localeCompare(b.name));

            filteredTrainees.forEach(trainee => {
                let completedEvents = [];
                try {
                    completedEvents = trainee.trainingEvents || [];
                } catch(e) {
                    console.error("Failed to parse trainee events:", e);
                }

                const hasCompleted = completedEvents.includes(selectedEventId);
                const traineeItem = document.createElement('div');
                traineeItem.className = 'flex items-center space-x-2 p-2 bg-gray-50 rounded-lg';
                traineeItem.innerHTML = `
                    <input type="checkbox" id="update-event-${trainee.id}" data-trainee-id="${trainee.id}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" ${hasCompleted ? 'checked' : ''}>
                    <label for="update-event-${trainee.id}" class="block text-sm text-gray-900 flex-1">${trainee.name}</label>
                `;
                traineeEventUpdateListEl.appendChild(traineeItem);
            });
        };
        
        selectAllTraineesCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            traineeEventUpdateListEl.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        });

        const renderTraineeEventViewList = () => {
            const selectedEventId = viewEventSelectorEl.value;
            const selectedPlatoon = currentPlatoonFilter;
            traineeEventViewListEl.innerHTML = '';

            if (!selectedEventId) {
                traineeEventViewListEl.innerHTML = '<p class="text-center text-gray-500">Please select a training event.</p>';
                return;
            }

            let filteredTrainees = traineesData;
            if (selectedPlatoon !== 'All') {
                filteredTrainees = traineesData.filter(trainee => trainee.platoon === selectedPlatoon);
            }
            
            if (filteredTrainees.length === 0) {
                 traineeEventViewListEl.innerHTML = '<p class="text-center text-gray-500">No trainees found for this platoon.</p>';
                 return;
            }
            
            filteredTrainees.sort((a, b) => a.name.localeCompare(b.name));

            filteredTrainees.forEach(trainee => {
                let completedEvents = [];
                try {
                    completedEvents = trainee.trainingEvents || [];
                } catch(e) {
                    console.error("Failed to parse trainee events:", e);
                }

                const hasCompleted = completedEvents.includes(selectedEventId);
                const traineeItem = document.createElement('div');
                traineeItem.className = `flex items-center space-x-2 p-3 rounded-lg shadow-sm ${hasCompleted ? 'bg-green-50' : 'bg-red-50'}`;
                traineeItem.innerHTML = `
                    <span class="flex-1 font-semibold text-gray-900">${trainee.name}</span>
                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${hasCompleted ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">
                        ${hasCompleted ? 'Completed' : 'Not Completed'}
                    </span>
                `;
                traineeEventViewListEl.appendChild(traineeItem);
            });
        };

        // --- DAILY CHECK-IN & APP RESET ---
        const performDailyCheckIn = async () => {
            if (!userId) return; // Don't run if user isn't authenticated yet
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/_metadata/app`);
            try {
                const userDocSnap = await getDoc(userDocRef);
                const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                
                if (userDocSnap.exists() && userDocSnap.data().lastDailyCheckIn === today) {
                    return; // Check-in already done for today
                }

                dailyCheckInListEl.innerHTML = '';
                traineesData.forEach(trainee => {
                    const checkInItem = document.createElement('div');
                    checkInItem.className = 'flex items-center space-x-4 p-2 bg-gray-50 rounded-lg';
                    checkInItem.innerHTML = `
                        <div class="flex-1 font-semibold">${trainee.name}</div>
                        <select class="status-select rounded-md border-gray-300 shadow-sm" data-id="${trainee.id}">
                            <option value="Present" ${trainee.status === 'Present' ? 'selected' : ''}>Present</option>
                            <option value="Sick Call" ${trainee.status === 'Sick Call' ? 'selected' : ''}>Sick Call</option>
                            <option value="On Leave" ${trainee.status === 'On Leave' ? 'selected' : ''}>On Leave</option>
                            <option value="Absent" ${trainee.status === 'Absent' ? 'selected' : ''}>Absent</option>
                            <option value="Other" ${trainee.status === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    `;
                    dailyCheckInListEl.appendChild(checkInItem);
                });

                dailyCheckInModal.classList.remove('hidden');
                document.body.classList.add('modal-open');
            } catch (error) {
                console.error("Error performing daily check-in:", error);
            }
        };
        
        skipCheckInBtn.addEventListener('click', async () => {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/_metadata/app`);
            await setDoc(userDocRef, { lastDailyCheckIn: new Date().toISOString().slice(0, 10) }, { merge: true });
            dailyCheckInModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
        });

        submitCheckInBtn.addEventListener('click', async () => {
            const selectElements = dailyCheckInListEl.querySelectorAll('.status-select');
            
            for (const selectEl of selectElements) {
                const traineeId = selectEl.dataset.id;
                const newStatus = selectEl.value;
                const trainee = traineesData.find(t => t.id === traineeId);
                
                if (trainee && trainee.status !== newStatus) {
                    const history = trainee.history || [];
                    history.push({
                        type: 'Status Update (Daily Check-in)',
                        details: `Status changed from '${trainee.status}' to '${newStatus}'.`,
                        timestamp: Timestamp.now()
                    });
                    
                    try {
                        const traineeDocRef = doc(db, `artifacts/${appId}/users/${userId}/trainees/${traineeId}`);
                        await setDoc(traineeDocRef, { status: newStatus, history: history }, { merge: true });
                    } catch (error) {
                        console.error(`Error updating trainee ${traineeId} during check-in:`, error);
                    }
                }
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/_metadata/app`);
            await setDoc(userDocRef, { lastDailyCheckIn: new Date().toISOString().slice(0, 10) }, { merge: true });
            dailyCheckInModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
        });

        const resetAllData = async () => {
            if (!userId) return;

            const collectionsToClear = [
                `artifacts/${appId}/users/${userId}/trainees`,
                `artifacts/${appId}/users/${userId}/training_events`,
                `artifacts/${appId}/users/${userId}/tasks`
            ];

            try {
                for (const colPath of collectionsToClear) {
                    const colRef = collection(db, colPath);
                    const docs = await getDocs(colRef);
                    const deletePromises = docs.docs.map(docToDelete => deleteDoc(docToDelete.ref));
                    await Promise.all(deletePromises);
                }

                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/_metadata/app`);
                await setDoc(userDocRef, { lastDailyCheckIn: null }, { merge: true });

            } catch (error) {
                console.error("Error resetting app data:", error);
            }
        };

        resetAppBtn.addEventListener('click', () => {
            showConfirmation(
                "Reset All App Data",
                "This will permanently delete all trainees, events, and tasks. This action cannot be undone.",
                resetAllData
            );
        });

        const updateDashboardTasks = () => {
            const outstandingCount = platoonTasks.filter(task => !task.completed).length;
            outstandingTasksCount.textContent = outstandingCount;
        }

        const renderTasksManagementList = () => {
            const outstandingTasks = platoonTasks.filter(task => !task.completed);
            const completedTasks = platoonTasks.filter(task => task.completed);
            
            outstandingTasks.sort((a, b) => {
                const priorityOrder = { 'High': 1, 'Medium': 2, 'Low': 3 };
                const dueDateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
                const dueDateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
                if (dueDateA !== dueDateB) return dueDateA - dueDateB;
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            const createTaskItemHTML = (task, isCompleted) => {
                const priorityClass = {
                    'High': 'bg-red-200 text-red-800',
                    'Medium': 'bg-yellow-200 text-yellow-800',
                    'Low': 'bg-gray-200 text-gray-800'
                }[task.priority] || 'bg-gray-200 text-gray-800';
                
                return `
                    <div class="flex items-center space-x-2 p-2 ${isCompleted ? 'bg-gray-200 text-gray-500' : 'bg-gray-50'} rounded-lg">
                        <input type="checkbox" id="task-${task.id}" data-task-id="${task.id}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 task-checkbox" ${isCompleted ? 'checked' : ''}>
                        <div class="flex-1 ${isCompleted ? 'line-through' : ''}">
                            <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${priorityClass}">${task.priority}</span>
                            <span class="ml-2">${task.text}</span>
                            ${task.dueDate ? `<span class="ml-2 text-xs">Due: ${formatDate(task.dueDate)}</span>` : ''}
                        </div>
                        <button class="text-red-500 hover:text-red-700 delete-task-btn" data-task-id="${task.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>`;
            };

            tasksManagementListEl.innerHTML = outstandingTasks.map(task => createTaskItemHTML(task, false)).join('') || '<p class="text-center text-gray-500">No outstanding tasks.</p>';
            completedTasksListEl.innerHTML = completedTasks.map(task => createTaskItemHTML(task, true)).join('');

            document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', async (e) => {
                    const taskId = e.target.dataset.taskId;
                    const isCompleted = e.target.checked;
                    try {
                        const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks/${taskId}`);
                        await setDoc(taskDocRef, { completed: isCompleted }, { merge: true });
                    } catch (error) { console.error("Error updating task status:", error); }
                });
            });

            document.querySelectorAll('.delete-task-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const taskId = e.currentTarget.dataset.taskId;
                    showConfirmation("Delete Task", "Are you sure you want to delete this task?", async () => {
                        try {
                            const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks/${taskId}`);
                            await deleteDoc(taskDocRef);
                        } catch (error) { console.error("Error deleting task:", error); }
                    });
                });
            });
        };

    </script>
</body>
</html>

